<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>实验课程目标达成度分析系统</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #2980b9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            background-color: #eee;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active {
            background-color: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .student-row:hover {
            background-color: #e6f7ff;
        }
        .highlight-low {
            background-color: #ffcccc !important;
        }
        .highlight-medium {
            background-color: #fff3cd !important;
        }
        .highlight-high {
            background-color: #d4edda !important;
        }
        .score-display {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
        }
        .analysis-panel {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-top: 15px;
        }
        .filter-panel {
            background-color: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .warning-badge {
            background-color: #dc3545;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
        .success-badge {
            background-color: #28a745;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>实验课程目标达成度分析系统</h1>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('basic-info')">基本信息</div>
            <div class="tab" onclick="switchTab('data-input')">数据输入</div>
            <div class="tab" onclick="switchTab('analysis-results')">分析结果</div>
            <div class="tab" onclick="switchTab('chart-analysis')">图表分析</div>
            <div class="tab" onclick="switchTab('filter-analysis')">筛选分析</div>
        </div>
        
        <!-- 基本信息编辑 -->
        <div id="basic-info" class="tab-content active">
            <h2>基本信息编辑</h2>
            <div class="section">
                <div class="form-group">
                    <label for="table-name">表格名称</label>
                    <input type="text" id="table-name" value="《大学物理实验II》课程目标达成度分析表">
                </div>
                <div class="form-group">
                    <label for="course-type">课程性质</label>
                    <input type="text" id="course-type" value="公共基础">
                </div>
                <div class="form-group">
                    <label for="course-credit">课程学分</label>
                    <input type="number" id="course-credit" step="0.1" value="0.5">
                </div>
                <div class="form-group">
                    <label for="teacher-name">教师姓名</label>
                    <input type="text" id="teacher-name" value="马厂">
                </div>
                <div class="form-group">
                    <label for="class-name">班级</label>
                    <input type="text" id="class-name" value="信息与计算科学2024(1)(2)(3)班">
                </div>
            </div>
            
            <div class="section">
                <h3>权重设置</h3>
                <div class="form-group">
                    <label for="gamma1">γ₁ (课程目标1权重)</label>
                    <input type="number" id="gamma1" step="0.1" min="0" max="1" value="0.4">
                </div>
                <div class="form-group">
                    <label for="gamma2">γ₂ (课程目标2权重)</label>
                    <input type="number" id="gamma2" step="0.1" min="0" max="1" value="0.5">
                </div>
                <div class="form-group">
                    <label for="gamma3">γ₃ (课程目标3权重)</label>
                    <input type="number" id="gamma3" step="0.1" min="0" max="1" value="0.1">
                </div>
            </div>
            
            <div class="section">
                <h3>成绩系数设置</h3>
                <div class="form-group">
                    <label for="preview-coefficient">预习报告系数</label>
                    <input type="number" id="preview-coefficient" step="0.1" min="0" max="1" value="0.1">
                </div>
                <div class="form-group">
                    <label for="experiment-coefficient">实验成绩系数</label>
                    <input type="number" id="experiment-coefficient" step="0.1" min="0" max="1" value="0.4">
                </div>
                <div class="form-group">
                    <label for="operation-coefficient">实验操作系数</label>
                    <input type="number" id="operation-coefficient" step="0.1" min="0" max="1" value="0.2">
                </div>
                <div class="form-group">
                    <label for="assessment-coefficient">考核成绩系数</label>
                    <input type="number" id="assessment-coefficient" step="0.1" min="0" max="1" value="0.3">
                </div>
            </div>
            
            <button onclick="saveBasicInfo()">保存基本信息</button>
        </div>
        
        <!-- 数据输入 -->
        <div id="data-input" class="tab-content">
            <h2>数据输入</h2>
            <div class="section">
                <button onclick="addStudent()">添加学生</button>
                <button onclick="removeSelectedStudents()">删除选中学生</button>
                <button onclick="importFromExcel()">从Excel导入</button>
                <button onclick="exportToExcel()">导出到Excel</button>
                <button onclick="autoFillSampleData()">填充示例数据</button>
                <input type="file" id="file-input" style="display: none;" accept=".xlsx,.xls">
            </div>
            
            <div class="section">
                <table id="input-table">
                    <thead>
                        <tr>
                            <th><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></th>
                            <th>序号</th>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>实验预习</th>
                            <th>实验操作与质量</th>
                            <th>实验报告</th>
                            <th>考核成绩-目标1</th>
                            <th>考核成绩-目标2</th>
                            <th>考核成绩-目标3</th>
                        </tr>
                    </thead>
                    <tbody id="input-data">
                        <!-- 数据将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 分析结果 -->
        <div id="analysis-results" class="tab-content">
            <h2>分析结果</h2>
            <div class="section">
                <button onclick="exportAnalysisResultsToExcel()">导出分析结果到Excel</button>
                <table id="result-table">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>预习报告</th>
                            <th>实验成绩</th>
                            <th>考核成绩</th>
                            <th>实验操作</th>
                            <th>R1</th>
                            <th>R2</th>
                            <th>R3</th>
                            <th>课程达成度R</th>
                        </tr>
                    </thead>
                    <tbody id="result-data">
                        <!-- 结果将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h3>达成度平均值</h3>
                <table>
                    <tr>
                        <th>目标1均值 (R1)</th>
                        <th>目标2均值 (R2)</th>
                        <th>目标3均值 (R3)</th>
                        <th>总达成度均值</th>
                    </tr>
                    <tr>
                        <td id="avg-r1" class="score-display">0.0000</td>
                        <td id="avg-r2" class="score-display">0.0000</td>
                        <td id="avg-r3" class="score-display">0.0000</td>
                        <td id="avg-total" class="score-display">0.0000</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- 图表分析 -->
        <div id="chart-analysis" class="tab-content">
            <h2>图表分析</h2>
            <div class="section">
                <div class="chart-container">
                    <canvas id="achievement-chart"></canvas>
                </div>
            </div>
        </div>
        
        <!-- 筛选分析 -->
        <div id="filter-analysis" class="tab-content">
            <h2>筛选分析与学情分析</h2>
            
            <div class="filter-panel">
                <h3>筛选功能</h3>
                <button onclick="filterLowR1()">筛选R1 < 0.6</button>
                <button onclick="filterLowR2()">筛选R2 < 0.6</button>
                <button onclick="filterLowR3()">筛选R3 < 0.6</button>
                <button onclick="filterAllLow()">筛选R1、R2、R3均 < 0.6</button>
                <button onclick="filterMultipleLow()">筛选至少两项 < 0.6</button>
                <button onclick="clearAllFilters()">清除筛选</button>
            </div>
            
            <div class="section">
                <h3>筛选结果</h3>
                <table id="filter-table">
                    <thead>
                        <tr>
                            <th>序号</th>
                            <th>学号</th>
                            <th>姓名</th>
                            <th>R1</th>
                            <th>R2</th>
                            <th>R3</th>
                            <th>课程达成度R</th>
                            <th>状态标识</th>
                        </tr>
                    </thead>
                    <tbody id="filter-data">
                        <!-- 筛选结果将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>
            
            <div class="analysis-panel" id="learning-analysis">
                <h3>学情分析报告</h3>
                <div id="analysis-content">
                    <p>请选择筛选条件或点击"生成学情分析报告"查看详细分析。</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let students = [];
        let chart = null;
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 添加一些示例学生
            for (let i = 0; i < 5; i++) {
                addStudent();
            }
            
            // 初始化图表
            initChart();
            
            // 计算初始结果
            calculateResults();
        });
        
        // 切换标签页
        function switchTab(tabId) {
            // 隐藏所有标签内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 取消所有标签的活动状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的标签内容
            document.getElementById(tabId).classList.add('active');
            
            // 设置选中标签的活动状态
            event.currentTarget.classList.add('active');
            
            // 如果是图表标签，重新绘制图表
            if (tabId === 'chart-analysis') {
                updateChart();
            }
        }
        
        // 保存基本信息
        function saveBasicInfo() {
            alert('基本信息已保存！');
        }
        
        // 添加学生
        function addStudent() {
            const tbody = document.getElementById('input-data');
            const newId = students.length + 1;
            
            const tr = document.createElement('tr');
            tr.className = 'student-row';
            tr.innerHTML = `
                <td><input type="checkbox" class="student-checkbox"></td>
                <td>${newId}</td>
                <td><input type="text" class="student-id" placeholder="学号"></td>
                <td><input type="text" class="student-name" placeholder="姓名"></td>
                <td><input type="number" class="preview-score" placeholder="预习" min="0" max="100" onchange="calculateResults()"></td>
                <td><input type="number" class="operation-score" placeholder="操作" min="0" max="100" onchange="calculateResults()"></td>
                <td><input type="number" class="report-score" placeholder="报告" min="0" max="100" onchange="calculateResults()"></td>
                <td><input type="number" class="assessment-score1" placeholder="目标1" min="0" max="100" onchange="calculateResults()"></td>
                <td><input type="number" class="assessment-score2" placeholder="目标2" min="0" max="100" onchange="calculateResults()"></td>
                <td><input type="number" class="assessment-score3" placeholder="目标3" min="0" max="100" onchange="calculateResults()"></td>
            `;
            
            tbody.appendChild(tr);
            
            // 添加到学生数组
            students.push({
                id: newId,
                studentId: '',
                name: '',
                previewScore: null,
                operationScore: null,
                reportScore: null,
                assessmentScores: [null, null, null]
            });
        }
        
        // 填充示例数据
        function autoFillSampleData() {
            const sampleData = [
                {id: '202441101102', name: '王婉霞', preview: 76.67, operation: 81.67, report: 80.56, a1: 39, a2: 46, a3: 9},
                {id: '202441101104', name: '万星', preview: 80, operation: 85, report: 82.5, a1: 38, a2: 39, a3: 9},
                {id: '202441101105', name: '候若菲', preview: 76.67, operation: 81.67, report: 80.94, a1: 38, a2: 46, a3: 7},
                {id: '202441101106', name: '李宝鑫', preview: 73.33, operation: 78.33, report: 76.39, a1: 37, a2: 44, a3: 8},
                {id: '202441101107', name: '周府康', preview: 85, operation: 90, report: 88.89, a1: 38, a2: 47, a3: 8}
            ];
            
            const rows = document.querySelectorAll('#input-data tr');
            sampleData.forEach((data, index) => {
                if (rows[index]) {
                    rows[index].querySelector('.student-id').value = data.id;
                    rows[index].querySelector('.student-name').value = data.name;
                    rows[index].querySelector('.preview-score').value = data.preview;
                    rows[index].querySelector('.operation-score').value = data.operation;
                    rows[index].querySelector('.report-score').value = data.report;
                    rows[index].querySelector('.assessment-score1').value = data.a1;
                    rows[index].querySelector('.assessment-score2').value = data.a2;
                    rows[index].querySelector('.assessment-score3').value = data.a3;
                }
            });
            
            calculateResults();
            alert('示例数据已填充！');
        }
        
        // 删除选中的学生
        function removeSelectedStudents() {
            const checkboxes = document.querySelectorAll('.student-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('请先选择要删除的学生！');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${checkboxes.length} 条学生记录吗？`)) {
                checkboxes.forEach(checkbox => {
                    const tr = checkbox.closest('tr');
                    const index = Array.from(tr.parentNode.children).indexOf(tr) - 1;
                    
                    students.splice(index, 1);
                    tr.remove();
                });
                
                updateStudentIds();
                calculateResults();
            }
        }
        
        // 更新学生序号
        function updateStudentIds() {
            const rows = document.querySelectorAll('#input-data tr');
            rows.forEach((row, index) => {
                const idCell = row.querySelector('td:nth-child(2)');
                idCell.textContent = index + 1;
                
                if (students[index]) {
                    students[index].id = index + 1;
                }
            });
        }
        
        // 全选/取消全选
        function toggleSelectAll() {
            const selectAll = document.getElementById('select-all').checked;
            document.querySelectorAll('.student-checkbox').forEach(checkbox => {
                checkbox.checked = selectAll;
            });
        }
        
        // 从Excel导入数据
        function importFromExcel() {
            document.getElementById('file-input').click();
        }
        
        // 处理文件导入
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                
                document.getElementById('input-data').innerHTML = '';
                students = [];
                
                for (let i = 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (row.length === 0) continue;
                    
                    addStudent();
                    
                    const lastIndex = students.length - 1;
                    const currentStudent = students[lastIndex];
                    const currentRow = document.querySelector(`#input-data tr:nth-child(${lastIndex + 1})`);
                    
                    if (row[1]) {
                        currentStudent.studentId = row[1].toString();
                        currentRow.querySelector('.student-id').value = row[1].toString();
                    }
                    
                    if (row[2]) {
                        currentStudent.name = row[2].toString();
                        currentRow.querySelector('.student-name').value = row[2].toString();
                    }
                    
                    // 实验预习
                    if (row[3] !== undefined && row[3] !== null && row[3] !== '') {
                        const score = parseFloat(row[3]);
                        if (!isNaN(score)) {
                            currentStudent.previewScore = score;
                            currentRow.querySelector('.preview-score').value = score;
                        }
                    }
                    
                    // 实验操作与质量
                    if (row[4] !== undefined && row[4] !== null && row[4] !== '') {
                        const score = parseFloat(row[4]);
                        if (!isNaN(score)) {
                            currentStudent.operationScore = score;
                            currentRow.querySelector('.operation-score').value = score;
                        }
                    }
                    
                    // 实验报告
                    if (row[5] !== undefined && row[5] !== null && row[5] !== '') {
                        const score = parseFloat(row[5]);
                        if (!isNaN(score)) {
                            currentStudent.reportScore = score;
                            currentRow.querySelector('.report-score').value = score;
                        }
                    }
                    
                    // 考核成绩
                    for (let j = 6; j <= 8; j++) {
                        if (row[j] !== undefined && row[j] !== null && row[j] !== '') {
                            const score = parseFloat(row[j]);
                            if (!isNaN(score)) {
                                currentStudent.assessmentScores[j-6] = score;
                                currentRow.querySelector(`.assessment-score${j-5}`).value = score;
                            }
                        }
                    }
                }
                
                calculateResults();
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });
        
        // 导出到Excel
        function exportToExcel() {
            const data = [];
            
            data.push([
                '序号', '学号', '姓名', 
                '实验预习', '实验操作与质量', '实验报告',
                '考核成绩-目标1', '考核成绩-目标2', '考核成绩-目标3'
            ]);
            
            const rows = document.querySelectorAll('#input-data tr');
            rows.forEach(row => {
                const rowData = [
                    row.querySelector('td:nth-child(2)').textContent,
                    row.querySelector('.student-id').value,
                    row.querySelector('.student-name').value,
                    row.querySelector('.preview-score').value || '',
                    row.querySelector('.operation-score').value || '',
                    row.querySelector('.report-score').value || '',
                    row.querySelector('.assessment-score1').value || '',
                    row.querySelector('.assessment-score2').value || '',
                    row.querySelector('.assessment-score3').value || ''
                ];
                data.push(rowData);
            });
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "实验成绩数据");
            
            const tableName = document.getElementById('table-name').value || '实验课程数据';
            XLSX.writeFile(wb, `${tableName}.xlsx`);
        }
        
        // 计算结果
        function calculateResults() {
            const gamma1 = parseFloat(document.getElementById('gamma1').value) || 0;
            const gamma2 = parseFloat(document.getElementById('gamma2').value) || 0;
            const gamma3 = parseFloat(document.getElementById('gamma3').value) || 0;
            const previewCoeff = parseFloat(document.getElementById('preview-coefficient').value) || 0;
            const experimentCoeff = parseFloat(document.getElementById('experiment-coefficient').value) || 0;
            const operationCoeff = parseFloat(document.getElementById('operation-coefficient').value) || 0;
            const assessmentCoeff = parseFloat(document.getElementById('assessment-coefficient').value) || 0;
            
            const totalGamma = gamma1 + gamma2 + gamma3;
            if (Math.abs(totalGamma - 1) > 0.001) {
                alert(`警告：课程目标权重总和应为1，当前为${totalGamma}`);
            }
            
            const totalCoeff = previewCoeff + experimentCoeff + operationCoeff + assessmentCoeff;
            if (Math.abs(totalCoeff - 1) > 0.001) {
                alert(`警告：成绩系数总和应为1，当前为${totalCoeff}`);
            }
            
            const resultTbody = document.getElementById('result-data');
            resultTbody.innerHTML = '';
            
            let totalR1 = 0, totalR2 = 0, totalR3 = 0, totalAchievement = 0;
            let validCount = 0;
            
            const rows = document.querySelectorAll('#input-data tr');
            rows.forEach((row, index) => {
                const studentId = row.querySelector('.student-id').value;
                const name = row.querySelector('.student-name').value;
                
                const previewScore = parseFloat(row.querySelector('.preview-score').value) || 0;
                const operationScore = parseFloat(row.querySelector('.operation-score').value) || 0;
                const reportScore = parseFloat(row.querySelector('.report-score').value) || 0;
                const assessmentScore1 = parseFloat(row.querySelector('.assessment-score1').value) || 0;
                const assessmentScore2 = parseFloat(row.querySelector('.assessment-score2').value) || 0;
                const assessmentScore3 = parseFloat(row.querySelector('.assessment-score3').value) || 0;
                
                // 计算各部分成绩
                const experimentScore = (previewScore * previewCoeff + reportScore * experimentCoeff + operationScore * operationCoeff) / (previewCoeff + experimentCoeff + operationCoeff);
                const assessmentTotal = assessmentScore1 + assessmentScore2 + assessmentScore3;
                
                // 计算各项R值
                const r1 = (experimentScore * (previewCoeff + experimentCoeff + operationCoeff) * gamma1 + assessmentScore1 * assessmentCoeff) / (gamma1 * 100);
                const r2 = (experimentScore * (previewCoeff + experimentCoeff + operationCoeff) * gamma2 + assessmentScore2 * assessmentCoeff) / (gamma2 * 100);
                const r3 = (experimentScore * (previewCoeff + experimentCoeff + operationCoeff) * gamma3 + assessmentScore3 * assessmentCoeff) / (gamma3 * 100);
                
                const achievement = gamma1 * r1 + gamma2 * r2 + gamma3 * r3;
                
                if (previewScore > 0 || operationScore > 0 || reportScore > 0 || assessmentTotal > 0) {
                    totalR1 += r1;
                    totalR2 += r2;
                    totalR3 += r3;
                    totalAchievement += achievement;
                    validCount++;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${studentId}</td>
                    <td>${name}</td>
                    <td>${previewScore.toFixed(2)}</td>
                    <td>${experimentScore.toFixed(2)}</td>
                    <td>${assessmentTotal.toFixed(2)}</td>
                    <td>${operationScore.toFixed(2)}</td>
                    <td class="${getAchievementClass(r1)}">${r1.toFixed(4)}</td>
                    <td class="${getAchievementClass(r2)}">${r2.toFixed(4)}</td>
                    <td class="${getAchievementClass(r3)}">${r3.toFixed(4)}</td>
                    <td>${achievement.toFixed(4)}</td>
                `;
                resultTbody.appendChild(tr);
                
                if (students[index]) {
                    students[index] = {
                        id: index + 1,
                        studentId,
                        name,
                        previewScore,
                        operationScore,
                        reportScore,
                        assessmentScores: [assessmentScore1, assessmentScore2, assessmentScore3],
                        experimentScore,
                        assessmentTotal,
                        r1,
                        r2,
                        r3,
                        achievement
                    };
                }
            });
            
            if (validCount > 0) {
                document.getElementById('avg-r1').textContent = (totalR1 / validCount).toFixed(4);
                document.getElementById('avg-r2').textContent = (totalR2 / validCount).toFixed(4);
                document.getElementById('avg-r3').textContent = (totalR3 / validCount).toFixed(4);
                document.getElementById('avg-total').textContent = (totalAchievement / validCount).toFixed(4);
            } else {
                document.getElementById('avg-r1').textContent = '0.0000';
                document.getElementById('avg-r2').textContent = '0.0000';
                document.getElementById('avg-r3').textContent = '0.0000';
                document.getElementById('avg-total').textContent = '0.0000';
            }
            
            updateChart();
        }
        
        // 获取达成度等级样式
        function getAchievementClass(value) {
            if (value < 0.6) return 'highlight-low';
            if (value < 0.8) return 'highlight-medium';
            return 'highlight-high';
        }
        
        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('achievement-chart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'R1',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.5)',
                            tension: 0.1
                        },
                        {
                            label: 'R2',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.5)',
                            tension: 0.1
                        },
                        {
                            label: 'R3',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.5)',
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 1,
                            title: {
                                display: true,
                                text: '达成度'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '学生序号'
                            }
                        }
                    }
                }
            });
        }
        
        // 更新图表数据
        function updateChart() {
            if (!chart) return;
            
            const labels = [];
            const r1Data = [];
            const r2Data = [];
            const r3Data = [];
            
            students.forEach(student => {
                labels.push(student.id);
                r1Data.push(student.r1 || 0);
                r2Data.push(student.r2 || 0);
                r3Data.push(student.r3 || 0);
            });
            
            chart.data.labels = labels;
            chart.data.datasets[0].data = r1Data;
            chart.data.datasets[1].data = r2Data;
            chart.data.datasets[2].data = r3Data;
            
            chart.update();
        }
        
        // 导出分析结果到Excel
        function exportAnalysisResultsToExcel() {
            const data = [];
            
            // 添加基本信息
            const tableName = document.getElementById('table-name').value;
            const courseType = document.getElementById('course-type').value;
            const courseCredit = document.getElementById('course-credit').value;
            const teacherName = document.getElementById('teacher-name').value;
            const className = document.getElementById('class-name').value;
            
            data.push(['课程名称', tableName]);
            data.push(['课程性质', courseType]);
            data.push(['课程学分', courseCredit]);
            data.push(['任课教师', teacherName]);
            data.push(['授课班级', className]);
            data.push([]);
            
            // 添加权重信息
            const gamma1 = document.getElementById('gamma1').value;
            const gamma2 = document.getElementById('gamma2').value;
            const gamma3 = document.getElementById('gamma3').value;
            data.push(['课程目标权重设置']);
            data.push(['γ₁ (课程目标1权重)', gamma1]);
            data.push(['γ₂ (课程目标2权重)', gamma2]);
            data.push(['γ₃ (课程目标3权重)', gamma3]);
            data.push([]);
            
            // 添加成绩系数信息
            const previewCoeff = document.getElementById('preview-coefficient').value;
            const experimentCoeff = document.getElementById('experiment-coefficient').value;
            const operationCoeff = document.getElementById('operation-coefficient').value;
            const assessmentCoeff = document.getElementById('assessment-coefficient').value;
            data.push(['成绩系数设置']);
            data.push(['预习报告系数', previewCoeff]);
            data.push(['实验成绩系数', experimentCoeff]);
            data.push(['实验操作系数', operationCoeff]);
            data.push(['考核成绩系数', assessmentCoeff]);
            data.push([]);
            
            // 添加分析结果表头
            data.push(['分析结果']);
            data.push([
                '序号', '学号', '姓名', 
                '预习报告', '实验成绩', '考核成绩', '实验操作',
                'R1', 'R2', 'R3', '课程达成度R'
            ]);
            
            // 添加学生分析结果数据
            const resultRows = document.querySelectorAll('#result-data tr');
            resultRows.forEach(row => {
                const rowData = [
                    row.querySelector('td:nth-child(1)').textContent,
                    row.querySelector('td:nth-child(2)').textContent,
                    row.querySelector('td:nth-child(3)').textContent,
                    row.querySelector('td:nth-child(4)').textContent,
                    row.querySelector('td:nth-child(5)').textContent,
                    row.querySelector('td:nth-child(6)').textContent,
                    row.querySelector('td:nth-child(7)').textContent,
                    row.querySelector('td:nth-child(8)').textContent,
                    row.querySelector('td:nth-child(9)').textContent,
                    row.querySelector('td:nth-child(10)').textContent,
                    row.querySelector('td:nth-child(11)').textContent
                ];
                data.push(rowData);
            });
            data.push([]);
            
            // 添加平均值
            data.push(['达成度平均值']);
            data.push(['目标1均值 (R1)', document.getElementById('avg-r1').textContent]);
            data.push(['目标2均值 (R2)', document.getElementById('avg-r2').textContent]);
            data.push(['目标3均值 (R3)', document.getElementById('avg-r3').textContent]);
            data.push(['总达成度均值', document.getElementById('avg-total').textContent]);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "分析结果");
            
            const fileName = `${tableName}_分析结果.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
        
        // 筛选功能
        function filterLowR1() {
            const filtered = students.filter(student => student.r1 < 0.6);
            displayFilteredResults(filtered, 'R1 < 0.6');
            generateLearningAnalysis(filtered, 'R1');
        }
        
        function filterLowR2() {
            const filtered = students.filter(student => student.r2 < 0.6);
            displayFilteredResults(filtered, 'R2 < 0.6');
            generateLearningAnalysis(filtered, 'R2');
        }
        
        function filterLowR3() {
            const filtered = students.filter(student => student.r3 < 0.6);
            displayFilteredResults(filtered, 'R3 < 0.6');
            generateLearningAnalysis(filtered, 'R3');
        }
        
        function filterAllLow() {
            const filtered = students.filter(student => 
                student.r1 < 0.6 && student.r2 < 0.6 && student.r3 < 0.6
            );
            displayFilteredResults(filtered, 'R1、R2、R3均 < 0.6');
            generateLearningAnalysis(filtered, 'all');
        }
        
        function filterMultipleLow() {
            const filtered = students.filter(student => {
                let lowCount = 0;
                if (student.r1 < 0.6) lowCount++;
                if (student.r2 < 0.6) lowCount++;
                if (student.r3 < 0.6) lowCount++;
                return lowCount >= 2;
            });
            displayFilteredResults(filtered, '至少两项 < 0.6');
            generateLearningAnalysis(filtered, 'multiple');
        }
        
        function clearAllFilters() {
            document.getElementById('filter-data').innerHTML = '';
            document.getElementById('analysis-content').innerHTML = '<p>请选择筛选条件或点击"生成学情分析报告"查看详细分析。</p>';
        }
        
        function displayFilteredResults(filteredStudents, filterType) {
            const tbody = document.getElementById('filter-data');
            tbody.innerHTML = '';
            
            if (filteredStudents.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="8">没有找到${filterType}的学生</td>`;
                tbody.appendChild(tr);
                return;
            }
            
            // 按序号排序
            filteredStudents.sort((a, b) => a.id - b.id);
            
            filteredStudents.forEach(student => {
                const tr = document.createElement('tr');
                const statusBadge = getStatusBadge(student);
                
                tr.innerHTML = `
                    <td>${student.id}</td>
                    <td>${student.studentId}</td>
                    <td>${student.name}</td>
                    <td class="${getAchievementClass(student.r1)}">${student.r1 ? student.r1.toFixed(4) : '-'}</td>
                    <td class="${getAchievementClass(student.r2)}">${student.r2 ? student.r2.toFixed(4) : '-'}</td>
                    <td class="${getAchievementClass(student.r3)}">${student.r3 ? student.r3.toFixed(4) : '-'}</td>
                    <td>${student.achievement ? student.achievement.toFixed(4) : '-'}</td>
                    <td>${statusBadge}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function getStatusBadge(student) {
            let badges = [];
            if (student.r1 < 0.6) badges.push('<span class="warning-badge">R1预警</span>');
            if (student.r2 < 0.6) badges.push('<span class="warning-badge">R2预警</span>');
            if (student.r3 < 0.6) badges.push('<span class="warning-badge">R3预警</span>');
            
            if (badges.length === 0) {
                return '<span class="success-badge">正常</span>';
            }
            return badges.join(' ');
        }
        
        function generateLearningAnalysis(filteredStudents, filterType) {
            const analysisDiv = document.getElementById('analysis-content');
            
            if (filteredStudents.length === 0) {
                analysisDiv.innerHTML = '<p>没有符合条件的学生，无法生成学情分析报告。</p>';
                return;
            }
            
            let analysisHTML = '<h4>学情分析报告</h4>';
            
            // 基本统计
            analysisHTML += `<p><strong>筛选条件：</strong>${getFilterTypeName(filterType)}</p>`;
            analysisHTML += `<p><strong>涉及学生人数：</strong>${filteredStudents.length} 人</p>`;
            analysisHTML += `<p><strong>占比：</strong>${(filteredStudents.length / students.length * 100).toFixed(1)}%</p>`;
            
            // 详细分析
            if (filterType === 'all' || filterType === 'multiple') {
                analysisHTML += '<h5>深度分析</h5>';
                analysisHTML += '<p><strong>问题严重性：</strong>';
                
                if (filterType === 'all') {
                    analysisHTML += '这类学生在所有课程目标上均未达标，表明其在实验课程的各个方面都存在明显不足，需要重点关注和干预。';
                } else {
                    analysisHTML += '这类学生在多个课程目标上未达标，说明存在较为严重的学习困难，需要针对性地加强辅导。';
                }
                analysisHTML += '</p>';
                
                // 成绩分析
                const avgPreview = filteredStudents.reduce((sum, s) => sum + (s.previewScore || 0), 0) / filteredStudents.length;
                const avgOperation = filteredStudents.reduce((sum, s) => sum + (s.operationScore || 0), 0) / filteredStudents.length;
                const avgReport = filteredStudents.reduce((sum, s) => sum + (s.reportScore || 0), 0) / filteredStudents.length;
                
                analysisHTML += '<h5>成绩特征分析</h5>';
                analysisHTML += '<ul>';
                analysisHTML += `<li>平均预习成绩：${avgPreview.toFixed(2)} 分</li>`;
                analysisHTML += `<li>平均操作成绩：${avgOperation.toFixed(2)} 分</li>`;
                analysisHTML += `<li>平均报告成绩：${avgReport.toFixed(2)} 分</li>`;
                analysisHTML += '</ul>';
                
                // 建议措施
                analysisHTML += '<h5>改进建议</h5>';
                analysisHTML += '<ol>';
                analysisHTML += '<li><strong>个别辅导：</strong>为这类学生安排专门的辅导时间，进行一对一指导</li>';
                analysisHTML += '<li><strong>学习方法指导：</strong>帮助他们建立正确的实验学习方法，加强课前预习</li>';
                analysisHTML += '<li><strong>基础强化：</strong>针对基础薄弱的环节进行重点训练，如实验操作规范等</li>';
                analysisHTML += '<li><strong>同伴互助：</strong>安排成绩优秀的学生与他们结对，提供学习帮助</li>';
                analysisHTML += '<li><strong>过程监控：</strong>加强对他们学习过程的监督和检查，及时发现问题</li>';
                analysisHTML += '</ol>';
                
                // 学生名单
                analysisHTML += '<h5>重点关注学生名单</h5>';
                analysisHTML += '<table class="table table-sm">';
                analysisHTML += '<tr><th>序号</th><th>学号</th><th>姓名</th><th>R1</th><th>R2</th><th>R3</th></tr>';
                filteredStudents.forEach(student => {
                    analysisHTML += `<tr>
                        <td>${student.id}</td>
                        <td>${student.studentId}</td>
                        <td>${student.name}</td>
                        <td>${student.r1.toFixed(4)}</td>
                        <td>${student.r2.toFixed(4)}</td>
                        <td>${student.r3.toFixed(4)}</td>
                    </tr>`;
                });
                analysisHTML += '</table>';
            } else {
                // 单个目标分析
                const targetName = filterType.toUpperCase();
                analysisHTML += `<h5>${targetName} 达成度分析</h5>`;
                analysisHTML += `<p>这些学生在课程目标${filterType.slice(1)}的达成上存在困难，需要针对性地加强相关能力的培养。</p>`;
                
                // 具体建议
                analysisHTML += '<h5>针对性改进措施</h5>';
                if (filterType === 'r1') {
                    analysisHTML += '<ul>';
                    analysisHTML += '<li>加强实验前的预习指导，提供详细的预习提纲</li>';
                    analysisHTML += '<li>在实验开始前进行预习检查，确保学生理解实验原理</li>';
                    analysisHTML += '<li>增加理论知识的复习和巩固环节</li>';
                    analysisHTML += '</ul>';
                } else if (filterType === 'r2') {
                    analysisHTML += '<ul>';
                    analysisHTML += '<li>加强实验操作技能的训练，增加练习机会</li>';
                    analysisHTML += '<li>提供操作视频或示范，帮助学生掌握正确方法</li>';
                    analysisHTML += '<li>在实验过程中加强指导和纠正</li>';
                    analysisHTML += '</ul>';
                } else if (filterType === 'r3') {
                    analysisHTML += '<ul>';
                    analysisHTML += '<li>加强实验数据处理和结果分析的指导</li>';
                    analysisHTML += '<li>提供报告撰写的模板和范例</li>';
                    analysisHTML += '<li>组织实验结果讨论，提高分析能力</li>';
                    analysisHTML += '</ul>';
                }
            }
            
            analysisDiv.innerHTML = analysisHTML;
        }
        
        function getFilterTypeName(filterType) {
            const names = {
                'r1': 'R1 < 0.6',
                'r2': 'R2 < 0.6',
                'r3': 'R3 < 0.6',
                'all': 'R1、R2、R3均 < 0.6',
                'multiple': '至少两项 < 0.6'
            };
            return names[filterType] || filterType;
        }
    </script>
</body>
</html>