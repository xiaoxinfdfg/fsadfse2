<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>液体表面张力系数的测定实验报告</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            padding: 30px;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #4a6fa5;
            padding-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
            border-left: 4px solid #4a6fa5;
        }
        .section-title {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            vertical-align: top;
        }
        th {
            background-color: #4a6fa5;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        tr:hover {
            background-color: #f1f7ff;
        }
        .blank {
            display: inline-block;
            min-width: 80px;
            border-bottom: 1px dashed #3498db;
            margin: 0 5px;
            padding: 2px 5px;
            background-color: #f8fcff;
        }
        .blank input {
            border: none;
            background: transparent;
            width: 100%;
            outline: none;
        }
        .control-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        button {
            background-color: #4a6fa5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }
        button:hover {
            background-color: #3a5a80;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .result-area {
            background-color: #e8f4f8;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }
        .result-title {
            color: #2c3e50;
            margin-top: 0;
        }
        #comment {
            background-color: #fffde7;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid #ffeb3b;
            min-height: 80px;
        }
        .chart-container {
            margin: 30px 0;
            position: relative;
            height: 400px;
            width: 100%;
        }
        .data-input {
            width: 80px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .formula {
            font-style: italic;
            background-color: #f0f8ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }
        .score-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #27ae60;
        }
        .experiment-content {
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 3px solid #ddd;
        }
        .score-details {
            margin-top: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .score-item {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        .score-item span:first-child {
            color: #666;
        }
        .score-item span:last-child {
            font-weight: bold;
        }
        .total-score {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #4a6fa5;
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
            font-size: 14px;
        }
        .summary-area {
            margin-top: 20px;
        }
        footer {
            margin-top: 40px;
            text-align: center;
            color: #7f8c8d;
            font-size: 0.9em;
            padding-top: 20px;
        }
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            table {
                font-size: 12px;
            }
            th, td {
                padding: 6px;
            }
        }

        /* 新增：错误标红样式 */
        .error-highlight {
            background-color: #ffe6e6 !important;
            border-bottom: 1px solid #ff4444 !important;
            color: #cc0000 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>液体表面张力系数的测定实验报告</h1>
        </header>
        
        <div class="section">
            <h2 class="section-title">一、基本信息</h2>
            <table>
                <tr>
                    <th width="15%">专业</th>
                    <td width="35%"><input type="text" class="blank" id="major" placeholder="填写专业"></td>
                    <th width="15%">班级</th>
                    <td width="35%"><input type="text" class="blank" id="class" placeholder="填写班级"></td>
                </tr>
                <tr>
                    <th>学号</th>
                    <td><input type="text" class="blank" id="student-id" placeholder="填写学号"></td>
                    <th>姓名</th>
                    <td><input type="text" class="blank" id="name" placeholder="填写姓名"></td>
                </tr>
                <tr>
                    <th>指导教师</th>
                    <td><input type="text" class="blank" id="instructor" value="马厂" placeholder="填写指导教师"></td>
                    <th>同组人</th>
                    <td><input type="text" class="blank" id="partner" placeholder="填写同组人"></td>
                </tr>
                <tr>
                    <th>实验时间</th>
                    <td><input type="date" class="blank" id="date" value="2023-11-15"></td>
                    <th>实验地点</th>
                    <td><input type="text" class="blank" id="location" placeholder="填写实验地点"></td>
                </tr>
            </table>
        </div>
        
        <div class="section">
            <h2 class="section-title">二、实验内容</h2>
            
            <h3>实验目的</h3>
            <p>1. 用<span class="blank"><input type="text" id="aim1" placeholder="填写方法" onblur="checkAnswer('aim1')"></span>测量室温下液体表面张力系数；</p>
            <p>2. 学习力敏传感器的<span class="blank"><input type="text" id="aim2" placeholder="填写方法" onblur="checkAnswer('aim2')"></span>方法。</p>
            
            <h3>实验仪器</h3>
            <p>液体表面张力系数测定仪包括电源、数字电压表、<span class="blank"><input type="text" id="instrument1" placeholder="填写仪器" onblur="checkAnswer('instrument1')"></span>、<span class="blank"><input type="text" id="instrument2" placeholder="填写仪器" onblur="checkAnswer('instrument2')"></span>、装有力敏传感器固定杆、<span class="blank"><input type="text" id="instrument3" placeholder="填写仪器" onblur="checkAnswer('instrument3')"></span>和<span class="blank"><input type="text" id="instrument4" placeholder="填写仪器" onblur="checkAnswer('instrument4')"></span>等。</p>
            
            <h3>实验原理</h3>
            <p>通过测量一个已知周长的圆环形吊片从待测液体表面脱离时需要的力，求得该液体表面张力系数的实验方法称为拉脱法。</p>
            <div class="formula">
                F = απ(D₁ + D₂)
            </div>
            <p>式中，F为<span class="blank"><input type="text" id="principle1" placeholder="填写物理量" onblur="checkAnswer('principle1')"></span>，D₁和D₂分别为圆环的<span class="blank"><input type="text" id="principle2" placeholder="填写参数" onblur="checkAnswer('principle2')"></span>和<span class="blank"><input type="text" id="principle3" placeholder="填写参数" onblur="checkAnswer('principle3')"></span>，α为液体的<span class="blank"><input type="text" id="principle4" placeholder="填写物理量" onblur="checkAnswer('principle4')"></span>。</p>
            
            <p>硅压阻式力敏传感器由弹性梁和贴在梁上的传感器芯片组成，其中传感器芯片由四个硅扩散电阻集成一个非平衡电桥，当外界压力作用于金属梁时，在压力作用下，电桥失去平衡，此时将有电压信号输出，输出电压大小与所加外力成正此，即：</p>
            <div class="formula">
                ΔU = KF
            </div>
            <p>式中，F为外力的大小，K为硅压阻式力敏传感器的<span class="blank"><input type="text" id="principle5" placeholder="填写参数" onblur="checkAnswer('principle5')"></span>，ΔU为传感器<span class="blank"><input type="text" id="principle6" placeholder="填写参数" onblur="checkAnswer('principle6')"></span>的大小。</p>
            
            <h3>实验内容</h3>
            
            <div class="experiment-content">
                <p>1．力敏传感器的定标。</p>
                <p>每个力敏传感器的灵敏度都有所不同，在实验前，应先将其定标，定标步骤如下：</p>
                <p>（1）打开仪器的电源开关，将仪器预热；</p>
                <p>（2）在传感器梁端头的小钩中，挂上砝码盘，调节<span class="blank"><input type="text" id="content1" placeholder="填写操作" onblur="checkAnswer('content1')"></span>，使<span class="blank"><input type="text" id="content2" placeholder="填写仪器" onblur="checkAnswer('content2')"></span>显示为零；</p>
                <p>（3）在砝码盘上分别加上如0.5g、1.0g、1.5g、2.0g、2.5g、3.0g等质量的砝码，记录数字电压表的读数值U，数据记录于表1；</p>
                <p>（4）用<span class="blank"><input type="text" id="content3" placeholder="填写方法" onblur="checkAnswer('content3')"></span>作直线拟合，求出传感器灵敏度K。</p>
            </div>
            
            <div class="experiment-content">
                <p>2．圆环形吊片的测量与清洁。</p>
                <p>（1）用游标卡尺测量圆环形吊片的外直径D₁和内直径D₂。</p>
                <p>（2）圆环形吊片的表面状况与测量结果有很大的关系，实验前应将圆环形吊片在NaOH溶液中浸泡20～30min，然后用纯净水洗净。</p>
            </div>
            
            <div class="experiment-content">
                <p>3．计算液体的表面张力系数。</p>
                <p>（1）将圆环形吊片挂在传感器的小钩上，调节<span class="blank"><input type="text" id="content4" placeholder="填写操作" onblur="checkAnswer('content4')"></span>，将液体升至靠近圆环形吊片的下沿，观察<span class="blank"><input type="text" id="content5" placeholder="填写仪器" onblur="checkAnswer('content5')"></span>下沿与待测液面是否平行，若不平行，则将圆环形吊片取下后，调节圆环形吊片上的<span class="blank"><input type="text" id="content6" placeholder="填写部件" onblur="checkAnswer('content6')"></span>，使圆环形吊片与待测液面平行。</p>
                <p>（2）调节容器下的升降旋钮，使其渐渐上升，将圆环形吊片的下沿部分<span class="blank"><input type="text" id="content7" placeholder="填写状态" onblur="checkAnswer('content7')"></span>待测液体，然后反向调节升降台，使液面逐渐下降，这时，圆环形吊片和液面间形成一<span class="blank"><input type="text" id="content8" placeholder="填写现象" onblur="checkAnswer('content8')"></span>，继续下降液面，测出环形液膜即将拉断前一瞬间数字电压表读数值U₁和液膜拉断后一瞬间数字电压表读数值U₂，则ΔU=U₁−U₂，将实验数据记录于表2重复操作5次。</p>
                <p>（3）将实验数据代入公式，求出液体的表面张力系数，并与标准值进行比较，计算相对误差。</p>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">三、实验数据记录与处理</h2>
            
            <h3>表1 传感器灵敏度测量数据</h3>
            <table id="table1">
                <thead>
                    <tr>
                        <th>砝码质量/g</th>
                        <th>0.5</th>
                        <th>1.0</th>
                        <th>1.5</th>
                        <th>2.0</th>
                        <th>2.5</th>
                        <th>3.0</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>砝码重力/N</td>
                        <td id="f1">0.0049</td>
                        <td id="f2">0.0098</td>
                        <td id="f3">0.0147</td>
                        <td id="f4">0.0196</td>
                        <td id="f5">0.0245</td>
                        <td id="f6">0.0294</td>
                    </tr>
                    <tr>
                        <td>电压/mV</td>
                        <td><input type="number" class="data-input" id="u1" step="0.1" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u2" step="0.1" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u3" step="0.1" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u4" step="0.1" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u5" step="0.1" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u6" step="0.1" placeholder="mV"></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="control-buttons">
                <button onclick="calculateSensitivity()">计算灵敏度K</button>
                <button onclick="drawCalibrationChart()">绘制校准曲线</button>
            </div>
            
            <div id="sensitivity-result" class="result-area" style="display:none;">
                <h3 class="result-title">灵敏度计算结果</h3>
                <p>根据表1数据绘制电压-砝码重力关系，并线性拟合求得斜率K = <span id="K-value" class="score-display"></span> mV/N</p>
                <p>拟合的线性相关系数 r = <span id="r-value" class="score-display"></span></p>
            </div>
            
            <h3>表2 表面张力系数测量数据</h3>
            <table id="table2">
                <thead>
                    <tr>
                        <th>编号</th>
                        <th>U₁/mV</th>
                        <th>U₂/mV</th>
                        <th>ΔU/mV</th>
                        <th>F/N</th>
                        <th>α/N·m⁻¹</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>1</td>
                        <td><input type="number" class="data-input" id="u1_1" step="0.01" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u2_1" step="0.01" placeholder="mV"></td>
                        <td id="deltaU1"></td>
                        <td id="F1"></td>
                        <td id="alpha1"></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td><input type="number" class="data-input" id="u1_2" step="0.01" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u2_2" step="0.01" placeholder="mV"></td>
                        <td id="deltaU2"></td>
                        <td id="F2"></td>
                        <td id="alpha2"></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td><input type="number" class="data-input" id="u1_3" step="0.01" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u2_3" step="0.01" placeholder="mV"></td>
                        <td id="deltaU3"></td>
                        <td id="F3"></td>
                        <td id="alpha3"></td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td><input type="number" class="data-input" id="u1_4" step="0.01" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u2_4" step="0.01" placeholder="mV"></td>
                        <td id="deltaU4"></td>
                        <td id="F4"></td>
                        <td id="alpha4"></td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td><input type="number" class="data-input" id="u1_5" step="0.01" placeholder="mV"></td>
                        <td><input type="number" class="data-input" id="u2_5" step="0.01" placeholder="mV"></td>
                        <td id="deltaU5"></td>
                        <td id="F5"></td>
                        <td id="alpha5"></td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 20px;">
                <label>圆环形吊片外直径 D₁ = <input type="number" id="D1" class="data-input" step="0.001" placeholder="cm"> cm</label>
                <label style="margin-left: 20px;">内直径 D₂ = <input type="number" id="D2" class="data-input" step="0.001" placeholder="cm"> cm</label>
                <label style="margin-left: 20px;">水的温度：t = <input type="number" id="temp" class="data-input" step="0.1" placeholder="℃"> ℃</label>
            </div>
            
            <div class="control-buttons">
                <button onclick="calculateAlpha()">计算表面张力系数α</button>
                <button onclick="calculateError()">计算相对误差</button>
            </div>
            
            <div id="alpha-result" class="result-area" style="display:none;">
                <h3 class="result-title">表面张力系数计算结果</h3>
                <p>α的平均值 = <span id="alpha-avg" class="score-display"></span> N·m⁻¹</p>
                <p>相对误差 = <span id="relative-error" class="score-display"></span></p>
                
                <div class="summary-area">
                    <h4>误差分析</h4>
                    <textarea id="error-analysis" placeholder="请分析实验误差的来源，如测量误差、环境因素、仪器精度、操作误差等。"></textarea>
                </div>
                
                <h4 style="margin-top: 15px;">附表：水的表面张力系数的标准值</h4>
                <table>
                    <thead>
                        <tr>
                            <th>水温 t/℃</th>
                            <th>10</th>
                            <th>15</th>
                            <th>20</th>
                            <th>25</th>
                            <th>30</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>α/N·m⁻¹</td>
                            <td>0.07422</td>
                            <td>0.07322</td>
                            <td>0.07275</td>
                            <td>0.07197</td>
                            <td>0.07118</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="chart-container">
                <canvas id="calibrationChart"></canvas>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">四、实验小结</h2>
            
            <div class="summary-area">
                <h3>实验小结</h3>
                <textarea id="experiment-summary" placeholder="请总结本次实验的收获、体会、发现的问题以及对实验的改进建议。"></textarea>
            </div>
            
            <div class="control-buttons">
                <button onclick="checkSummary()">检查小结完成情况</button>
            </div>
        </div>
        
        <div class="section">
            <h2 class="section-title">五、实验评分</h2>
            
            <!-- 新增：独立预习评分（百分制） -->
            <div class="control-buttons">
                <button onclick="calculatePreScore()">计算预习分数（百分制）</button>
            </div>
            <div id="pre-score" class="result-area" style="display:none;">
                <h3 class="result-title">预习分数计算结果</h3>
                <p>预习分数：<span id="pre-score-value" class="score-display"></span> / 100</p>
                <div id="pre-score-details" class="score-details"></div>
            </div>

            <!-- 原有：自动评分并生成评语 -->
            <div class="control-buttons" style="margin-top:20px;">
                <button onclick="autoScoreAndComment()">自动评分并生成评语</button>
            </div>
            <div id="auto-score-result" class="result-area" style="display:none;">
                <h3 class="result-title">评分结果</h3>
                <div id="score-details" class="score-details"></div>
                <div class="total-score">
                    报告得分：<span id="total-score-value" class="score-display"></span> / 100
                </div>

                <h3 class="result-title">实验评语</h3>
                <div id="comment"></div>
                <p style="margin-top: 15px; font-style: italic;">
                    指导教师：<span id="instructor-name">马厂</span> |
                    评语日期：<span id="comment-date"></span>
                </p>
            </div>
        </div>
        
        <footer>
            <p>请认真填写所有空白处，完成数据记录后进行计算和评分</p>
        </footer>
    </div>

    <script>
        // 正确答案
        const answers = {
            aim1: "拉脱法",
            aim2: "定标",
            instrument1: "金属架台",
            instrument2: "微调升降台",
            instrument3: "盛液体的玻璃皿",
            instrument4: "圆环形吊片",
            principle1: "脱离力",
            principle2: "外直径",
            principle3: "内直径",
            principle4: "表面张力系数",
            principle5: "灵敏度",
            principle6: "输出电压",
            content1: "调零旋钮",
            content2: "数字电压表",
            content3: "最小二乘法",
            content4: "升降台",
            content5: "圆环形吊片",
            content6: "细丝",
            content7: "全部浸没于",
            content8: "环形液膜"
        };
        
        // 水的表面张力系数标准值
        const alphaStandard = {
            10: 0.07422,
            15: 0.07322,
            20: 0.07275,
            25: 0.07197,
            30: 0.07118
        };
        
        // 初始化图表
        let calibrationChart = null;

        /* 新增：检查答案并标红错误 */
        function checkAnswer(id) {
            const input = document.getElementById(id);
            const userAnswer = input.value.trim().toLowerCase();
            const correctAnswer = answers[id].toLowerCase();
            
            if (userAnswer === '') {
                input.classList.remove('error-highlight');
            } else if (userAnswer !== correctAnswer) {
                input.classList.add('error-highlight');
            } else {
                input.classList.remove('error-highlight');
            }
        }

        /* ---------- 新增：独立预习评分（百分制） ---------- */
        function calculatePreScore() {
            const totalQuestions = Object.keys(answers).length;
            let correct = 0;

            for (const key in answers) {
                const input = document.getElementById(key);
                if (input && input.value.trim().toLowerCase() === answers[key].toLowerCase()) {
                    correct++;
                }
            }

            const preScore = Math.round((correct / totalQuestions) * 100);
            document.getElementById('pre-score-value').textContent = preScore;
            document.getElementById('pre-score').style.display = 'block';

            // 明细
            const detailDiv = document.getElementById('pre-score-details');
            detailDiv.innerHTML = `
                <div class="score-item">
                    <span>填空题正确率</span>
                    <span>${correct} / ${totalQuestions}</span>
                </div>
                <div style="font-size:12px;color:#666;margin-top:4px;">
                    ${correct === totalQuestions ? '✓ 全部正确！' : '✗ 仍有错误，请检查标红题目'}
                </div>
            `;
            return preScore;
        }
        
        // 检查实验小结完成情况
        function checkSummary() {
            const summary = document.getElementById('experiment-summary').value.trim();
            const wordCount = summary.length;
            const keywords = ["表面张力", "拉脱法", "灵敏度", "误差分析"];
            let keywordCount = 0;
            
            for (const keyword of keywords) {
                if (summary.includes(keyword)) {
                    keywordCount++;
                }
            }
            
            let message = `实验小结字数：${wordCount}字\n`;
            message += `包含关键词数量：${keywordCount}/4\n`;
            
            if (wordCount >= 50) {
                message += "✓ 字数达标（≥50字）\n";
            } else {
                message += "✗ 字数不足（＜50字）\n";
            }
            
            if (keywordCount >= 2) {
                message += "✓ 关键词数量达标（≥2个）";
            } else {
                message += "✗ 关键词数量不足（＜2个）";
            }
            
            alert(message);
        }
        
        // 计算传感器灵敏度K
        function calculateSensitivity() {
            // 获取电压数据
            const voltages = [];
            for (let i = 1; i <= 6; i++) {
                const voltage = parseFloat(document.getElementById(`u${i}`).value);
                if (!isNaN(voltage)) {
                    voltages.push(voltage);
                }
            }
            
            if (voltages.length < 3) {
                alert("请至少填写3个电压数据");
                return;
            }
            
            // 计算重力数据
            const forces = [0.0049, 0.0098, 0.0147, 0.0196, 0.0245, 0.0294].slice(0, voltages.length);
            
            // 线性回归计算斜率和相关系数
            const result = linearRegression(forces, voltages);
            
            document.getElementById('K-value').textContent = result.slope.toFixed(2);
            document.getElementById('r-value').textContent = result.r.toFixed(4);
            document.getElementById('sensitivity-result').style.display = 'block';
            
            // 保存K值供后续计算使用
            window.sensorSensitivity = result.slope;
        }
        
        // 绘制校准曲线
        function drawCalibrationChart() {
            const forces = [];
            const voltages = [];
            
            for (let i = 1; i <= 6; i++) {
                const force = parseFloat(document.getElementById(`f${i}`).textContent);
                const voltage = parseFloat(document.getElementById(`u${i}`).value);
                
                if (!isNaN(voltage)) {
                    forces.push(force);
                    voltages.push(voltage);
                }
            }
            
            if (forces.length < 2) {
                alert("请至少填写2个电压数据");
                return;
            }
            
            // 计算线性回归
            const result = linearRegression(forces, voltages);
            
            // 生成拟合数据点
            const fitForces = [0, Math.max(...forces) * 1.1];
            const fitVoltages = fitForces.map(f => result.slope * f + result.intercept);
            
            const ctx = document.getElementById('calibrationChart').getContext('2d');
            
            // 如果图表已存在，销毁它
            if (calibrationChart) {
                calibrationChart.destroy();
            }
            
            calibrationChart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: '实验数据',
                            data: forces.map((f, i) => ({x: f, y: voltages[i]})),
                            backgroundColor: 'rgba(54, 162, 235, 0.8)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            pointRadius: 8,
                            pointHoverRadius: 10
                        },
                        {
                            label: '拟合直线',
                            data: fitForces.map((f, i) => ({x: f, y: fitVoltages[i]})),
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            borderColor: 'rgba(255, 99, 132, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false,
                            showLine: true,
                            lineTension: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '砝码重力 F (N)',
                                font: {
                                    size: 14
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '输出电压 U (mV)',
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: '力敏传感器校准曲线',
                            font: {
                                size: 18
                            }
                        },
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    label += `(${context.parsed.x.toFixed(4)} N, ${context.parsed.y.toFixed(2)} mV)`;
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // 标记已绘制图表
            window.chartDrawn = true;
        }
        
        // 计算表面张力系数
        function calculateAlpha() {
            // 检查是否已计算灵敏度
            if (!window.sensorSensitivity) {
                alert("请先计算传感器灵敏度K");
                return;
            }
            
            const D1 = parseFloat(document.getElementById('D1').value);
            const D2 = parseFloat(document.getElementById('D2').value);
            
            if (isNaN(D1) || isNaN(D2)) {
                alert("请填写圆环形吊片的直径");
                return;
            }
            
            const K = window.sensorSensitivity;
            const alphas = [];
            
            // 计算每次测量的α值
            for (let i = 1; i <= 5; i++) {
                const U1 = parseFloat(document.getElementById(`u1_${i}`).value);
                const U2 = parseFloat(document.getElementById(`u2_${i}`).value);
                
                if (!isNaN(U1) && !isNaN(U2)) {
                    const deltaU = Math.abs(U1 - U2);
                    const F = deltaU / K;
                    const alpha = F / (Math.PI * (D1/100 + D2/100)); // 转换为米
                    
                    // 更新表格 - ΔU保留4位小数
                    document.getElementById(`deltaU${i}`).textContent = deltaU.toFixed(4);
                    document.getElementById(`F${i}`).textContent = F.toFixed(6);
                    document.getElementById(`alpha${i}`).textContent = alpha.toFixed(6);
                    
                    alphas.push(alpha);
                }
            }
            
            if (alphas.length === 0) {
                alert("请至少填写一组U₁和U₂数据");
                return;
            }
            
            // 计算平均值
            const avgAlpha = alphas.reduce((sum, val) => sum + val, 0) / alphas.length;
            document.getElementById('alpha-avg').textContent = avgAlpha.toFixed(6);
            document.getElementById('alpha-result').style.display = 'block';
            
            // 保存平均值供后续使用
            window.alphaAverage = avgAlpha;
        }
        
        // 计算相对误差
        function calculateError() {
            const temp = parseFloat(document.getElementById('temp').value);
            
            if (isNaN(temp)) {
                alert("请填写水的温度");
                return;
            }
            
            if (!window.alphaAverage) {
                alert("请先计算表面张力系数α");
                return;
            }
            
            // 查找最接近的温度对应的标准值
            const temps = Object.keys(alphaStandard).map(Number);
            const closestTemp = temps.reduce((prev, curr) => {
                return Math.abs(curr - temp) < Math.abs(prev - temp) ? curr : prev;
            });
            
            const standardAlpha = alphaStandard[closestTemp];
            const relativeError = Math.abs((window.alphaAverage - standardAlpha) / standardAlpha) * 100;
            
            document.getElementById('relative-error').textContent = relativeError.toFixed(2) + "%";
            document.getElementById('alpha-result').style.display = 'block';
            
            // 保存相对误差
            window.relativeError = relativeError;
        }
        
        // 自动评分并生成评语
        function autoScoreAndComment() {
            // 评分标准
            const scoringCriteria = {
                prepFill: 30,   // 预习填空
                chart: 20,      // 图表是否绘制
                summary: 20,    // 实验小结（关键词 + 字数）
                errorAna: 15,   // 误差分析区是否填写
                normErr: 15     // 相对误差 < 5% 拿满，> 30% 拿 0
            };
            
            let totalScore = 0;
            let scoreDetails = [];
            
            // 1. 预习填空评分 (30分)
            let prepScore = 0;
            let correctCount = 0;
            let totalQuestions = Object.keys(answers).length;
            
            for (const key in answers) {
                const input = document.getElementById(key);
                if (input && input.value.trim().toLowerCase() === answers[key].toLowerCase()) {
                    correctCount++;
                }
            }
            
            prepScore = Math.round((correctCount / totalQuestions) * scoringCriteria.prepFill);
            scoreDetails.push({ name: "预习填空", score: prepScore, max: scoringCriteria.prepFill, details: `正确${correctCount}/${totalQuestions}题` });
            totalScore += prepScore;
            
            // 2. 图表绘制评分 (20分)
            let chartScore = window.chartDrawn ? scoringCriteria.chart : 0;
            scoreDetails.push({ name: "图表绘制", score: chartScore, max: scoringCriteria.chart, details: window.chartDrawn ? "已绘制" : "未绘制" });
            totalScore += chartScore;
            
            // 3. 实验小结评分 (20分)
            let summaryScore = 0;
            const summary = document.getElementById('experiment-summary').value.trim();
            const wordCount = summary.length;
            const keywords = ["表面张力", "拉脱法", "灵敏度", "误差分析"];
            let keywordCount = 0;
            
            for (const keyword of keywords) {
                if (summary.includes(keyword)) {
                    keywordCount++;
                }
            }
            
            if (wordCount >= 50) {
                summaryScore += 12; // 字数分
                if (keywordCount >= 4) summaryScore += 8;
                else if (keywordCount >= 3) summaryScore += 6;
                else if (keywordCount >= 2) summaryScore += 4;
                else if (keywordCount >= 1) summaryScore += 2;
            } else if (wordCount >= 30) {
                summaryScore += 8;
                if (keywordCount >= 2) summaryScore += 4;
                else if (keywordCount >= 1) summaryScore += 2;
            } else if (wordCount > 0) {
                summaryScore += 5;
                if (keywordCount >= 1) summaryScore += 2;
            }
            
            scoreDetails.push({ name: "实验小结", score: summaryScore, max: scoringCriteria.summary, details: `${wordCount}字, ${keywordCount}/4关键词` });
            totalScore += summaryScore;
            
            // 4. 误差分析评分 (15分)
            let errorAnaScore = 0;
            const errorAnalysis = document.getElementById('error-analysis').value.trim();
            if (errorAnalysis.length > 0) {
                errorAnaScore = scoringCriteria.errorAna;
            }
            scoreDetails.push({ name: "误差分析", score: errorAnaScore, max: scoringCriteria.errorAna, details: errorAnalysis.length > 0 ? "已填写" : "未填写" });
            totalScore += errorAnaScore;
            
            // 5. 相对误差评分 (15分)
            let normErrScore = 0;
            if (window.relativeError !== undefined) {
                // 相对误差 < 5% 拿满，> 30% 拿 0
                if (window.relativeError <= 5) normErrScore = 15;
                else if (window.relativeError >= 30) normErrScore = 0;
                else {
                    // 5% 到 30% 之间线性扣分
                    normErrScore = Math.round(15 - (window.relativeError - 5) / (30 - 5) * 15);
                }
            }
            scoreDetails.push({ name: "相对误差", score: normErrScore, max: scoringCriteria.normErr, details: window.relativeError !== undefined ? `${window.relativeError.toFixed(2)}%` : "未计算" });
            totalScore += normErrScore;
            
            // 显示评分详情
            const scoreDetailsHTML = scoreDetails.map(item => {
                const percentage = item.max > 0 ? Math.round(item.score / item.max * 100) : 0;
                const color = item.score >= item.max * 0.8 ? "#27ae60" : 
                             item.score >= item.max * 0.6 ? "#f39c12" : "#e74c3c";
                return `
                    <div class="score-item">
                        <span>${item.name}</span>
                        <span style="color: ${color}">${item.score}/${item.max} (${percentage}%)</span>
                    </div>
                    <div style="font-size: 12px; color: #666; margin-bottom: 10px;">${item.details}</div>
                `;
            }).join('');
            
            document.getElementById('score-details').innerHTML = scoreDetailsHTML;
            document.getElementById('total-score-value').textContent = totalScore;
            
            // 生成评语
            const instructor = document.getElementById('instructor').value || "马厂";
            
            // 生成评语
            let comment = "";
            
            if (totalScore >= 90) {
                comment = `实验报告优秀！报告得分${totalScore}分。预习充分，实验操作规范，数据处理准确，图表绘制完整，实验小结详细，误差分析到位。实验态度认真，结果可靠。`;
            } else if (totalScore >= 80) {
                comment = `实验报告良好！报告得分${totalScore}分。预习较好，实验操作基本规范，数据处理较为准确，图表绘制完整，实验小结较为详细。整体表现良好，但仍有改进空间。`;
            } else if (totalScore >= 70) {
                comment = `实验报告合格！报告得分${totalScore}分。基本完成实验要求，但部分环节存在不足。建议加强预习，提高数据处理准确性，完善实验小结和误差分析。`;
            } else if (totalScore >= 60) {
                comment = `实验报告基本合格！报告得分${totalScore}分。实验完成度一般，存在较多不足。需要加强预习和理解，规范实验操作，提高数据处理和分析能力。`;
            } else {
                comment = `实验报告有待改进！报告得分${totalScore}分。实验完成度较低，存在明显问题。请重新学习实验原理，认真完成实验操作，加强数据记录和分析能力。`;
            }
            
            // 添加具体建议
            let suggestions = [];
            
            // 检查各项目得分情况
            scoreDetails.forEach(item => {
                if (item.score < item.max * 0.7) {
                    if (item.name === "预习填空") suggestions.push("加强实验预习，掌握关键概念");
                    if (item.name === "图表绘制") suggestions.push("完成图表绘制，直观展示数据关系");
                    if (item.name === "实验小结") suggestions.push("完善实验小结，包含关键内容和思考");
                    if (item.name === "误差分析") suggestions.push("认真分析实验误差来源");
                    if (item.name === "相对误差") suggestions.push("减小实验误差，提高测量精度");
                }
            });
            
            if (suggestions.length > 0) {
                comment += "\n\n改进建议：" + suggestions.join("；");
            }
            
            // 更新评语
            document.getElementById('comment').textContent = comment;
            document.getElementById('instructor-name').textContent = instructor;
            
            // 设置当前日期
            const now = new Date();
            const dateStr = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;
            document.getElementById('comment-date').textContent = dateStr;
            
            document.getElementById('auto-score-result').style.display = 'block';
        }
        
        // 线性回归函数
        function linearRegression(x, y) {
            const n = x.length;
            
            // 计算均值
            const xMean = x.reduce((sum, val) => sum + val, 0) / n;
            const yMean = y.reduce((sum, val) => sum + val, 0) / n;
            
            // 计算斜率和截距
            let numerator = 0;
            let denominator = 0;
            
            for (let i = 0; i < n; i++) {
                numerator += (x[i] - xMean) * (y[i] - yMean);
                denominator += (x[i] - xMean) ** 2;
            }
            
            const slope = numerator / denominator;
            const intercept = yMean - slope * xMean;
            
            // 计算相关系数
            let sumXY = 0, sumX2 = 0, sumY2 = 0;
            for (let i = 0; i < n; i++) {
                sumXY += x[i] * y[i];
                sumX2 += x[i] ** 2;
                sumY2 += y[i] ** 2;
            }
            
            const r = (n * sumXY - x.reduce((s, v) => s + v, 0) * y.reduce((s, v) => s + v, 0)) /
                     Math.sqrt((n * sumX2 - (x.reduce((s, v) => s + v, 0) ** 2)) *
                              (n * sumY2 - (y.reduce((s, v) => s + v, 0) ** 2)));
            
            return { slope, intercept, r };
        }
        
        // 页面加载时设置默认日期
        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        });
    </script>
</body>
</html>